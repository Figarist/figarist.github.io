<!-- Viewport & Meta Base -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
<meta name="theme-color" content="#f2f0eb">
<meta name="robots" content="index, follow">
<meta name="google-site-verification" content="Whr2bJTggESM1pyCXLfqwodNQu6cNqk_XKdZ0ix2Tyk" />

<!-- Jekyll SEO Tag (Generates Title, OG, Twitter, JSON-LD, Canonical) -->
{% seo %}

<!-- CRITICAL: jekyll-polyglot Hreflang logic (DO NOT DELETE) -->
{% assign bare_url = page.url | remove_first: '/uk' | remove_first: '/ru' | remove_first: '/ko' %}
{% if bare_url == '' %}{% assign bare_url = '/' %}{% endif %}
<link rel="alternate" {% static_href %}href="{{ site.url }}{{ site.baseurl }}{{ bare_url }}" {% endstatic_href %}
    hreflang="en">
<link rel="alternate" {% static_href %}href="{{ site.url }}{{ site.baseurl }}/uk{{ bare_url }}" {% endstatic_href %}
    hreflang="uk">
<link rel="alternate" {% static_href %}href="{{ site.url }}{{ site.baseurl }}/ru{{ bare_url }}" {% endstatic_href %}
    hreflang="ru">
<link rel="alternate" {% static_href %}href="{{ site.url }}{{ site.baseurl }}/ko{{ bare_url }}" {% endstatic_href %}
    hreflang="ko">
<link rel="alternate" {% static_href %}href="{{ site.url }}{{ site.baseurl }}{{ bare_url }}" {% endstatic_href %}
    hreflang="x-default">

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
    href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Fira+Code:wght@400;500;600&display=swap"
    rel="stylesheet">

<link rel="stylesheet" href="{{ '/styles.css' | relative_url }}">

<!-- TASK 2: Auto-Redirect on First Visit & Preference -->
<script>
    (function () {
        try {
            var activeLang = '{{ site.active_lang }}';
            var preferredLang = localStorage.getItem('preferred_lang');
            var targetLang = null;

            // 1. Check if preference exists
            if (preferredLang) {
                if (preferredLang !== activeLang) {
                    targetLang = preferredLang;
                }
            } else {
                // 3. First time visitor: Detect browser language
                var browserLang = navigator.language || navigator.userLanguage;
                var languages = navigator.languages || [browserLang];
                var detectedLang = 'en'; // default

                if (languages.some(l => l.startsWith('uk'))) {
                    detectedLang = 'uk';
                } else if (languages.some(l => l.startsWith('ru'))) {
                    detectedLang = 'ru';
                } else if (languages.some(l => l.startsWith('ko'))) {
                    detectedLang = 'ko';
                }

                localStorage.setItem('preferred_lang', detectedLang);
                if (activeLang !== detectedLang) {
                    targetLang = detectedLang;
                }
            }

            // Execute Redirect
            if (targetLang && targetLang !== activeLang) {
                var currentPath = window.location.pathname;
                var pathWithoutLang = currentPath;
                var match = currentPath.match(/^\/(uk|ru|ko)(\/|$)/);
                if (match) {
                    pathWithoutLang = currentPath.substring(match[0].length);
                    if (!pathWithoutLang.startsWith('/')) {
                        pathWithoutLang = '/' + pathWithoutLang;
                    }
                }

                var prefix = targetLang === 'en' ? '' : '/' + targetLang;
                var nextPath = prefix + pathWithoutLang;
                // Add trailing slash check if it had one before (github pages standard)
                nextPath = nextPath.replace(/\/\//g, '/');
                if (nextPath === '') nextPath = '/';

                if (currentPath !== nextPath) {
                    window.location.replace(nextPath + window.location.hash);
                }
            }
        } catch (e) {
            // Failsafe mostly for Safari Private Mode / localStorage quota errors
            console.warn('Language auto-detect failed:', e);
        }
    })();
</script>

</head>